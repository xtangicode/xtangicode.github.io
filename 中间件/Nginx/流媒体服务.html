<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>协议介绍 | Sugar</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="Sugar">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.becc5145.js" as="script"><link rel="preload" href="/assets/js/2.8a031f56.js" as="script"><link rel="preload" href="/assets/js/20.7ea2bb80.js" as="script"><link rel="prefetch" href="/assets/js/10.52cab887.js"><link rel="prefetch" href="/assets/js/11.abfb551c.js"><link rel="prefetch" href="/assets/js/12.d46d8e6b.js"><link rel="prefetch" href="/assets/js/13.796cc617.js"><link rel="prefetch" href="/assets/js/14.abb8dcc2.js"><link rel="prefetch" href="/assets/js/15.bc632091.js"><link rel="prefetch" href="/assets/js/16.3e74429b.js"><link rel="prefetch" href="/assets/js/17.928891a5.js"><link rel="prefetch" href="/assets/js/18.2853db4c.js"><link rel="prefetch" href="/assets/js/19.e814de36.js"><link rel="prefetch" href="/assets/js/21.b9a970c5.js"><link rel="prefetch" href="/assets/js/22.8f0aad5d.js"><link rel="prefetch" href="/assets/js/23.37938e1b.js"><link rel="prefetch" href="/assets/js/24.0c1837d6.js"><link rel="prefetch" href="/assets/js/25.daa710f8.js"><link rel="prefetch" href="/assets/js/26.4741f167.js"><link rel="prefetch" href="/assets/js/27.2c3cd4f9.js"><link rel="prefetch" href="/assets/js/28.e7126f3b.js"><link rel="prefetch" href="/assets/js/29.69e495da.js"><link rel="prefetch" href="/assets/js/3.c07a09ea.js"><link rel="prefetch" href="/assets/js/30.60fd56a9.js"><link rel="prefetch" href="/assets/js/31.43a01ec1.js"><link rel="prefetch" href="/assets/js/32.3d0a5c7b.js"><link rel="prefetch" href="/assets/js/33.8bb206bd.js"><link rel="prefetch" href="/assets/js/34.7e634c3d.js"><link rel="prefetch" href="/assets/js/35.bebcaa97.js"><link rel="prefetch" href="/assets/js/36.ed4dd0bb.js"><link rel="prefetch" href="/assets/js/37.2999990f.js"><link rel="prefetch" href="/assets/js/38.3684e1b0.js"><link rel="prefetch" href="/assets/js/39.83466aa5.js"><link rel="prefetch" href="/assets/js/4.eb479c1a.js"><link rel="prefetch" href="/assets/js/40.e75a081b.js"><link rel="prefetch" href="/assets/js/41.650d4fe5.js"><link rel="prefetch" href="/assets/js/42.b36d86a2.js"><link rel="prefetch" href="/assets/js/43.229a5a6e.js"><link rel="prefetch" href="/assets/js/44.ded3279b.js"><link rel="prefetch" href="/assets/js/45.678478c0.js"><link rel="prefetch" href="/assets/js/46.33d79b2c.js"><link rel="prefetch" href="/assets/js/47.3c3fcf46.js"><link rel="prefetch" href="/assets/js/48.12df0a19.js"><link rel="prefetch" href="/assets/js/49.23fe9ddf.js"><link rel="prefetch" href="/assets/js/5.9462a6c1.js"><link rel="prefetch" href="/assets/js/50.1bf8997f.js"><link rel="prefetch" href="/assets/js/51.fd43798a.js"><link rel="prefetch" href="/assets/js/52.7f70dc4d.js"><link rel="prefetch" href="/assets/js/53.12136482.js"><link rel="prefetch" href="/assets/js/54.26249ffe.js"><link rel="prefetch" href="/assets/js/55.0a263515.js"><link rel="prefetch" href="/assets/js/56.4f05f519.js"><link rel="prefetch" href="/assets/js/57.52324724.js"><link rel="prefetch" href="/assets/js/58.5cb03987.js"><link rel="prefetch" href="/assets/js/59.41810f80.js"><link rel="prefetch" href="/assets/js/6.678bf046.js"><link rel="prefetch" href="/assets/js/60.0d67b809.js"><link rel="prefetch" href="/assets/js/61.7ceea6d8.js"><link rel="prefetch" href="/assets/js/62.87e71c61.js"><link rel="prefetch" href="/assets/js/63.fc9c302c.js"><link rel="prefetch" href="/assets/js/64.ca3808c3.js"><link rel="prefetch" href="/assets/js/65.e25f12cf.js"><link rel="prefetch" href="/assets/js/66.2ca8d64a.js"><link rel="prefetch" href="/assets/js/67.b7cdda32.js"><link rel="prefetch" href="/assets/js/68.f27a4837.js"><link rel="prefetch" href="/assets/js/69.8e3c9b33.js"><link rel="prefetch" href="/assets/js/7.929c4487.js"><link rel="prefetch" href="/assets/js/70.8f80e583.js"><link rel="prefetch" href="/assets/js/71.aaef6aba.js"><link rel="prefetch" href="/assets/js/72.45f1df49.js"><link rel="prefetch" href="/assets/js/8.06c0e874.js"><link rel="prefetch" href="/assets/js/9.e420af56.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sugar</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          SQL数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/数据库/MySQL/MySQL目录结构.html" class="nav-link">
  MySQL
</a></li></ul></li><li class="dropdown-item"><h4>
          NoSQL数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/数据库/ElasticSearch/ES知识体系.html" class="nav-link">
  ElasticSearch
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  MangoDB
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          后端框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  MyBatis
</a></li><li class="dropdown-subitem"><a href="/框架/Spring/SpEL&amp;EL表达式.html" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-subitem"><a href="/框架/Activiti/Activiti介绍.html" class="nav-link">
  Activiti
</a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  RabbitMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          服务器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/中间件/Nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-subitem"><a href="/中间件/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/运维/Linux/" class="nav-link">
  Linux
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          SQL数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/数据库/MySQL/MySQL目录结构.html" class="nav-link">
  MySQL
</a></li></ul></li><li class="dropdown-item"><h4>
          NoSQL数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/数据库/ElasticSearch/ES知识体系.html" class="nav-link">
  ElasticSearch
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  MangoDB
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          后端框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  MyBatis
</a></li><li class="dropdown-subitem"><a href="/框架/Spring/SpEL&amp;EL表达式.html" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-subitem"><a href="/框架/Activiti/Activiti介绍.html" class="nav-link">
  Activiti
</a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/.html" class="nav-link">
  RabbitMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          服务器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/中间件/Nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-subitem"><a href="/中间件/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/运维/Linux/" class="nav-link">
  Linux
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/中间件/Nginx/流媒体服务.html" class="active sidebar-link">流媒体服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#协议介绍" class="sidebar-link">协议介绍</a></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#ffmpeg介绍" class="sidebar-link">FFmpeg介绍</a></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#vlc播放器介绍" class="sidebar-link">VLC播放器介绍</a></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#直播" class="sidebar-link">直播</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#推流实现" class="sidebar-link">推流实现</a></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#拉流实现" class="sidebar-link">拉流实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#点播" class="sidebar-link">点播</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#点播实现" class="sidebar-link">点播实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#java操作ffmpeg" class="sidebar-link">JAVA操作FFmpeg</a></li><li class="sidebar-sub-header"><a href="/中间件/Nginx/流媒体服务.html#几种浏览器播放rtsp视频流解决方案" class="sidebar-link">几种浏览器播放RTSP视频流解决方案</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="协议介绍"><a href="#协议介绍" class="header-anchor">#</a> 协议介绍</h2> <p><strong>RTSP</strong>
RTSP （Real-Time Stream Protocol）由Real Networks 和 Netscape共同提出的，基于文本的多媒体播放控制协议。RTSP定义流格式，流数据经由RTP传输；RTSP实时效果非常好，适合视频聊天，视频监控等方向。一般摄像头都是RTSP格式的。h5原生不支持这种格式。
<strong>优点</strong>，可以控制到视频帧，因此可以承载实时性很高的应用。这个优点是相对于HTTP方式的最大优点。复杂度主要集中在服务器端，可以进行倍速播放功能，其他视频协议都无法支持。 网络延时低，一般在0.5S以内；
<strong>缺点</strong>，就是服务器端的复杂度也比较高，实现起来也比较复杂。ios端不支持该协议，对移动端支持较弱；除了 Firefox 浏览器可以直接播放 RTSP 流之外,几乎没有其他浏览器可以直接播放 RTSP 流。RTSP协议，此协议和RTMP效果差不多，在技术上只是区别于传输数据上占用多少通道、传输格式流不太一样而已，RTSP其实也可以用于直播。但依然是因为市场环境，RTSP目前主要应用在安防监控上，和RTMP一样，早已形成了自己的盈利链</p> <p><strong>RTMP</strong>
RTMP（Real Time Message Protocol） 有 Adobe 公司提出，用来解决多媒体数据传输流的多路复用（Multiplexing）和分包（packetizing）的问题，优势在于低延迟，稳定性高，支持所有摄像头格式，RTMP协议是采用实时的流式传输，所以不会缓存文件到客户端，这种特性说明用户想下载RTMP协议下的视频是比较难的，视频流可以随便拖动，既可以从任意时间点向服务器发送请求进行播放，并不需要视频有关键帧。相比而言，HTTP协议下视频需要有关键帧才可以随意拖动，rtmp协议只支持flashplayer 就是只能在PC端（或安卓环境中安装了flashplayer组件，这种环境比较少）安装了flashplayer的情况下使用，浏览器加载 flash插件就可以直接播放,但是flash已经日落西山了。因此，目前 RTMP 主要用于提取 stream。也就是，当设置解编码器将视频发送到托管平台时，视频将使用 RTMP 协议发送到 CDN，随后使用另一种协议（通常是HLS）传递给播放器</p> <p><strong>HTTP-FLV</strong> 即将流媒体数据封装成 FLV 格式，然后通过 HTTP 协议传输给客户端 HTTP协议中有个约定：content-length字段，http的body部分的长度服务器回复http请求的时候如果有这个字段，客户端就接收这个长度的数据然后就认为数据传输完成了，如果服务器回复http请求中没有这个字段，客户端就一直接收数据，直到服务器跟客户端的socket连接断开。http-flv直播就是利用第二个原理，服务器回复客户端请求的时候不加content-length字段，在回复了http内容之后，紧接着发送flv数据，客户端就一直接收数据了</p> <p><strong>HLS</strong>
当使用http协议的时候视频格式需要是m3u8或HTTP-FLV协议视频流。HLS 协议由三部分组成：HTTP、M3U8、TS。这三部分中，HTTP 是传输协议，M3U8 是索引文件，TS 是音视频的媒体信息m3u8是有延迟的。并不能实时，实时传输方面不如rtmp协议。因为m3u8的直播原理是将直播源不停的压缩成指定时长的ts文件（比如9秒，10秒一个ts文件）并同时实时更新m3u8文件里的列表以达到直播的效果。这样就会有一个至少9,10秒的时间延迟。如果压缩的过小，可能导致客户端网络原因致视频变卡。</p> <table><thead><tr><th></th> <th>RTMP/RTSP</th> <th>HTTP-FLV</th> <th>HLS</th></tr></thead> <tbody><tr><td>传输协议</td> <td>TCP</td> <td>HTTP</td> <td>HTTP</td></tr> <tr><td>视频封装格式</td> <td>flv</td> <td>flv</td> <td>ts</td></tr> <tr><td>延时</td> <td>1-3秒</td> <td>1-3秒</td> <td>5-20秒</td></tr> <tr><td>Web支持</td> <td>H5 不能直接播放</td> <td>H5 不能直接播放</td> <td>支持H5</td></tr> <tr><td>CPU</td> <td>11%</td> <td>4.4%</td> <td>3%</td></tr> <tr><td>数据</td> <td>连续流</td> <td>连续流</td> <td>切片文件</td></tr> <tr><td>优点</td> <td>基于TCP长连接，不需要多次建连，延时低，通常只有1~3s；技术成熟，配套完善。</td> <td>flv.js在获取到FLV格式的音视频数据后将 FLV 文件流转码复用成 ISO BMFF（MP4 碎片）片段，再通过Media Source Extensions API 传递给原生HTML5 Video标签进行播放。低延时，整体效果与RTMP非常接近；相较于RTMP协议，能有效避免防火墙和代理的影响。</td> <td>基于HTTP协议，所以接入CDN较为容易，很少被防火墙拦下，且自带多码率自适应；作为苹果提出的协议，在macOS/iOS下有极大优势，Android中也提供了对应的支持；可以说此项协议用在移动设备上是再合适不过了</td></tr> <tr><td>缺点</td> <td>在PC浏览器中只能通过Flash使用，且无法在移动浏览器使用；鉴于Flash即将退出舞台，所以在网页播放端基本不会以RTMP做拉流。</td> <td>把音视频数据封装成FLV，然后通过HTTP连接传输，与RTMP相比只是传输协议变了。对于网页播放端，本来还是需要Flash才能播放，但「flv.js」的出现又弥补了这个缺陷它的传输特性会让流媒体资源缓存在本地客户端，也就是说保密性不怎么样；直到目前仍然不兼容iOS的浏览器</td> <td>延时较大，通常不低于10s 。大量的TS片文件，会造成服务器存储和请求的压力</td></tr> <tr><td>推拉流</td> <td>推拉流</td> <td>拉流</td> <td>拉流</td></tr></tbody></table> <h2 id="ffmpeg介绍"><a href="#ffmpeg介绍" class="header-anchor">#</a> FFmpeg介绍</h2> <h2 id="vlc播放器介绍"><a href="#vlc播放器介绍" class="header-anchor">#</a> VLC播放器介绍</h2> <h2 id="直播"><a href="#直播" class="header-anchor">#</a> 直播</h2> <h3 id="推流实现"><a href="#推流实现" class="header-anchor">#</a> 推流实现</h3> <h4 id="媒体服务器搭建"><a href="#媒体服务器搭建" class="header-anchor">#</a> 媒体服务器搭建</h4> <p>方案一：Nginx添加模块nginx-rtmp-module
方案二：Nginx添加模块nginx-http-flv-module，安装教程参考：Nginx安装的添加nginx-http-flv-module模块教程
nginx-http-flv-module是基于nginx-rtmp-module 的流媒体服务器。它具备了所有nginx-rtmp-module的功能，并且新增多种新功能，功能对比如下</p> <table><thead><tr><th>Features</th> <th>nginx-http-flv-module</th> <th>nginx-rtmp-module</th> <th></th></tr></thead> <tbody><tr><td>HTTP-FLV (播放)</td> <td>支持</td> <td>不支持</td> <td>支持 HTTPS-FLV 和 chunked 回复</td></tr> <tr><td>GOP 缓存</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>虚拟主机</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>省略 listen 配置</td> <td>支持</td> <td>See remarks</td> <td>There MUST be at least one listen directive</td></tr> <tr><td>纯音频支持</td> <td>支持</td> <td>See remarks</td> <td>Won't work if wait_video or wait_key is on</td></tr> <tr><td>Single-track support for HLS</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>reuseport support</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>Timer for access log</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>JSON style statistics</td> <td>支持</td> <td>不支持</td> <td></td></tr> <tr><td>Statistics for recordings</td> <td>支持</td> <td>不支持</td> <td></td></tr></tbody></table> <p><strong>配置RTMP推流和HTTP-FLV拉流方式</strong></p> <p>配置nginx.conf</p> <div class="language-properties extra-class"><pre class="language-properties"><code>......
......
<span class="token key attr-name">rtmp</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">        listen</span> <span class="token value attr-value">20935;</span>
<span class="token key attr-name">        chunk_size</span> <span class="token value attr-value">4000;</span>
<span class="token comment">         # rtmp协议方式</span>
<span class="token key attr-name">        application</span> <span class="token value attr-value">liveRtmp {</span>
<span class="token key attr-name">            live</span> <span class="token value attr-value">on;</span>
<span class="token key attr-name">            gop_cache</span> <span class="token value attr-value">on;</span>
        }
    }
}

http{
<span class="token key attr-name"> 	include</span> <span class="token value attr-value">      /etc/nginx/mime.types;</span>
<span class="token key attr-name">    default_type</span> <span class="token value attr-value"> application/octet-stream;</span>
    ......
<span class="token key attr-name">    server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">        listen</span> <span class="token value attr-value">      80;</span>
<span class="token key attr-name">        server_name</span> <span class="token value attr-value"> localhost;</span>

<span class="token comment">        #access_log  /var/log/nginx/host.access.log  main;</span>

<span class="token key attr-name">        location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">            root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
<span class="token key attr-name">            index</span> <span class="token value attr-value"> index.html index.htm;</span>
        }
<span class="token key attr-name">        location</span> <span class="token value attr-value">/flvTest {</span>
<span class="token key attr-name">            flv_live</span> <span class="token value attr-value">on; #拉取HTTP-FLV的配置，打开HTTP播放FLV直播流功能</span>
<span class="token key attr-name">            chunked_transfer_encoding</span> <span class="token value attr-value">on; #支持’Transfer-Encoding: chunked’方式回复    </span>
<span class="token key attr-name">            add_header</span> <span class="token value attr-value">'Access-Control-Allow-Origin' '*'; #添加额外的HTTP头    </span>
<span class="token key attr-name">            add_header</span> <span class="token value attr-value">'Access-Control-Allow-Credentials' 'true'; #添加额外的HTTP头    </span>
<span class="token key attr-name">        }</span> 
     ......
<span class="token key attr-name">    }</span> <span class="token value attr-value"> </span>
}
   
</code></pre></div><p><strong>配置RTMP推流和HLS拉流方式</strong></p> <p>原理：</p> <ol><li>推流段RTMP推送</li> <li>媒体服务器，对flv文件切片输出ts视频文件和m3u8索引文件</li> <li>hls通过m3u8拉取ts文件播放</li></ol> <p>弊端：延迟过大，原因是切片及等推流数据</p> <p>优化：缩短ts间隔和个数，但还是比不过RTMP方式和HTTP-FLV方式。</p> <p>配置nginx.conf</p> <div class="language-properties extra-class"><pre class="language-properties"><code>......
......

<span class="token comment"># 推流时会发布到多个子进程</span>
<span class="token comment"># rtmp_auto_push on;</span>
<span class="token comment"># rtmp_auto_push_reconnect 1s;</span>
<span class="token key attr-name">rtmp</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">        listen</span> <span class="token value attr-value">20935;</span>
<span class="token key attr-name">        chunk_size</span> <span class="token value attr-value">4000;</span>
<span class="token comment">        # hls协议方式</span>
<span class="token key attr-name">        application</span> <span class="token value attr-value">liveHls {</span>
<span class="token key attr-name">           live</span> <span class="token value attr-value">on;</span>
<span class="token comment">           #HLS协议进行m3u8实时直播.如果是http-flv方式不需要配置下面的</span>
<span class="token comment">           #wait_key on;#保护TS切片</span>
<span class="token key attr-name">           hls</span> <span class="token value attr-value">on;  #实时回访</span>
<span class="token comment">           #hls_nested on;#每个流都自动创建一个文件夹</span>
<span class="token key attr-name">           hls_path</span> <span class="token value attr-value">/opt/videoTmp; #媒体块ts的位置</span>
<span class="token comment">           #hls_fragment 5s; #每个ts文件为5s的样子</span>
<span class="token comment">           #hls_playlist_length 30s;  #保存m3u8列表长度时间，默认是30秒，可考虑三小时10800秒</span>
<span class="token comment">           #hls_cleanup on;#是否删除列表中已经没有的媒体块TS文件，默认是开启</span>
<span class="token comment">           #hls_continuous on;#连续模式</span>

        }
    }
}

http{
<span class="token key attr-name"> 	include</span> <span class="token value attr-value">      /etc/nginx/mime.types;</span>
<span class="token key attr-name">    default_type</span> <span class="token value attr-value"> application/octet-stream;</span>
    ......
<span class="token key attr-name">    server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">        listen</span> <span class="token value attr-value">      80;</span>
<span class="token key attr-name">        server_name</span> <span class="token value attr-value"> localhost;</span>

<span class="token comment">        #access_log  /var/log/nginx/host.access.log  main;</span>

<span class="token key attr-name">        location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">            root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
<span class="token key attr-name">            index</span> <span class="token value attr-value"> index.html index.htm;</span>
        }
<span class="token comment">         # 拉m3u8的配置</span>
<span class="token key attr-name">         location</span> <span class="token value attr-value">/m3u8Test {</span>
<span class="token key attr-name">            types</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">                  application/vnd.apple.mpegurl</span> <span class="token value attr-value">m3u8;</span>
<span class="token key attr-name">                  video/mp2t</span> <span class="token value attr-value">ts;</span>
            }
<span class="token key attr-name">        	alias</span> <span class="token value attr-value">/opt/videoTmp;</span>
<span class="token key attr-name">        	expires</span> <span class="token value attr-value">-1;</span>
<span class="token key attr-name">        	add_header</span> <span class="token value attr-value">'Cache-Control' 'no-cache';</span>
   		 }

     ......
<span class="token key attr-name">    }</span> <span class="token value attr-value"> </span>
}
   
</code></pre></div><h4 id="使用工具推流"><a href="#使用工具推流" class="header-anchor">#</a> 使用工具推流</h4> <p>方案一：OBS推流
方案二：FFmpeg推流，将视频流推送到nginx上，可以安装在windows或者linux。安装在Linux教程参考：FFmpeg安装。</p> <ol><li>将视频文件<code>2.mp4</code>放到<code>/opt/</code>下，执行如下命令，将视频流通FFmpeg推送到nginx。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>ffmpeg  <span class="token parameter variable">-re</span> <span class="token parameter variable">-i</span> /opt/2.mp4 <span class="token parameter variable">-c</span> copy <span class="token parameter variable">-f</span> flv rtmp://127.0.0.1:20935/liveRtmp/room1
</code></pre></div><ol start="2"><li>如果图中参数一直改变表示正在推流
<img src="/assets/img/lmt_01.2b05b09f.jpg" alt=""></li></ol> <h3 id="拉流实现"><a href="#拉流实现" class="header-anchor">#</a> 拉流实现</h3> <p>前端一般可以播放媒体采用flv视频流或者读取m3u8中ts文件播放。</p> <h4 id="拉流地址"><a href="#拉流地址" class="header-anchor">#</a> 拉流地址</h4> <p><strong>推流方式：媒体文件-&gt;RTMP服务器-&gt;HTTP-FLV拉流</strong></p> <p>ffmpeg推流命令：<code>ffmpeg -re -i /opt/2.mp4 -c copy -f flv rtmp://127.0.0.1:20935/liveRtmp/room1</code>
rmtp拉流地址：rtmp://127.0.0.1:20935/liveRtmp/room1，可以采用VLC播放器播放
http-flv拉流地址：http://192.168.133.128/flvTest?port=20935&amp;app=liveRtmp&amp;stream=room1 ，可以采用flv.js或者VLC播放器播放。</p> <p><strong>推流方式：媒体文件-&gt;RTMP服务器-&gt;HLS拉流</strong></p> <p>ffmpeg推流命令：<code>ffmpeg -re -i /opt/2.mp4 -c copy -f flv rtmp://127.0.0.1:20935/liveHls/room2</code>
rmtp拉流地址：rtmp://192.168.133.128:20935/liveHls/room2，可以采用VLC播放器播放
hls-m3u8拉流地址：  http://192.168.133.128/m3u8Test/room2.m3u8  m3u8文件在/opt/videoTmp下，可以使用VLC播放器播放。</p> <p><strong>VLC播放</strong></p> <p>播放步骤：媒体-&gt;打开网络串流-&gt;添加地址(支持各种拉流地址)-&gt;下拉选播放</p> <p><strong>M3U8文件</strong></p> <p>读取m3u8文件配置，将ts文件拼接。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@txSugar videoTmp<span class="token punctuation">]</span><span class="token comment"># ls</span>
room2-0.ts  room2-1.ts  room2.m3u8
<span class="token punctuation">[</span>root@txSugar videoTmp<span class="token punctuation">]</span><span class="token comment"># cat room2.m3u8 </span>
<span class="token comment">#EXTM3U</span>
<span class="token comment">#EXT-X-VERSION:3</span>
<span class="token comment">#EXT-X-MEDIA-SEQUENCE:0     #当前索引</span>
<span class="token comment">#EXT-X-TARGETDURATION:8    	</span>
<span class="token comment">#EXT-X-DISCONTINUITY</span>
<span class="token comment">#EXTINF:8.424,</span>
room2-0.ts
<span class="token comment">#EXTINF:7.405,</span>
room2-1.ts
</code></pre></div><h4 id="前端拉流"><a href="#前端拉流" class="header-anchor">#</a> 前端拉流？</h4> <p><strong>方案一：</strong></p> <p>Video.js 是一个通用的在网页上嵌入视频播放器的 JS 库，Video.js 自动检测浏览器对 HTML5 的支持情况，如果不支持 HTML5 则自动使用 Flash 播放器。Edge、谷歌浏览器中网站默认是禁用flash的，手动设置为允许flash即可</p> <p>优点：</p> <p>1.它是开源免费的，你可以在github很容易的获取它的最新代码。
2.使用它非常的容易，只要花几秒钟就可以架起一个视频播放页面。
3.它几乎兼容所有的浏览器，并且优先使用html5，在不支持的浏览器中，会自动使用flash进行播放。
4.界面可以定制，纯javascript和css打造。说明文档也非常的详细。</p> <p>缺点：</p> <p>videojs针对部分摄像机（比如：海康）不是很友好，作者大大也很久没有维护的原因，部分rtsp、rtmp流的视频直播是无法找到媒体的兼容源</p> <p><strong>方案二：</strong></p> <p>利用B站开源的flv.js，通过将FLV文件流转换为ISO BMFF（Fragmented MP4）段，然后通过Media Source Extensions API 将mp4段提供给HTML5 元素。flv.js是支持在 HTML5 视频中播放 FLV 格式视频的 JavaScript 库。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pragma<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cache-control<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>expires<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, minimal-ui<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge,chrome=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-ua-compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=7,9,10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello flv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>播放<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>暂停<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>videoElement<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>500<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">border</span><span class="token punctuation">:</span>thin solid black</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">controls</span> <span class="token attr-name">loop</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flv.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">var</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'videoElement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> flvPlayer <span class="token operator">=</span> flvjs<span class="token punctuation">.</span><span class="token function">createPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">isLive</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'flv'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://192.168.133.128:80/flvTest?port=20935&amp;app=liveRtmp&amp;stream=room1'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">enableWorker</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">enableStashBuffer</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">stashInitialSize</span><span class="token operator">:</span> <span class="token number">128</span>    <span class="token comment">// 减少首桢显示等待时长</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flvPlayer<span class="token punctuation">.</span><span class="token function">attachMediaElement</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flvPlayer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            flvPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">function</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            flvPlayer<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>出现如下页面表示前段播放成功
<img src="/assets/img/lmt_02.7819814b.jpg" alt=""></p> <p><strong>方案三：</strong> 嵌入一个swf媒体播放文件，并利用该文件来播放你预设的文件。这里推荐dplayer——http://dplayer.js.org/zh/guide.html#flv</p> <h2 id="点播"><a href="#点播" class="header-anchor">#</a> 点播</h2> <p>播放本地视频文件</p> <h3 id="点播实现"><a href="#点播实现" class="header-anchor">#</a> 点播实现</h3> <p>在nginx已经安装上nginx-http-flv-module模块的基础上进行配置。
配置nginx.conf</p> <div class="language-shell extra-class"><pre class="language-shell"><code>events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
rtmp <span class="token punctuation">{</span>
    server <span class="token punctuation">{</span>
        listen <span class="token number">20935</span><span class="token punctuation">;</span>
        chunk_size <span class="token number">4000</span><span class="token punctuation">;</span> <span class="token comment">#单一推流数据包最大容量</span>
        <span class="token comment"># 点播配置</span>
        application vod <span class="token punctuation">{</span>
           play /opt/<span class="token punctuation">;</span> <span class="token comment">#//视频文件存放位置。</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后在/opt/存放2.mp4，点播地址：rtmp://192.168.133.128:20935/vod/2.mp4，使用VLC播放器直接播放。</p> <h2 id="java操作ffmpeg"><a href="#java操作ffmpeg" class="header-anchor">#</a> JAVA操作FFmpeg</h2> <p>java操作第三方程序一般需要使用Runtime包，具体代码实现如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Cleanup</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedReader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStreamReader</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description:
 * @author: Tx
 * @date: 2023-04-11  10:27
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaFFMpegUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">execCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> ffmpegCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">openFFmpegExe</span><span class="token punctuation">(</span>ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;结束执行ffmpegCmd：{}&quot;</span><span class="token punctuation">,</span> ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">openFFmpegExe</span><span class="token punctuation">(</span><span class="token class-name">String</span> ffmpegCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Runtime</span> rn <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Process</span> p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            p <span class="token operator">=</span> rn<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Cleanup</span>
            <span class="token class-name">BufferedInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getErrorStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Cleanup</span>
            <span class="token class-name">BufferedReader</span> inBr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> lineStr<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行ffmpegcmd：{}&quot;</span><span class="token punctuation">,</span> ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lineStr <span class="token operator">=</span> inBr<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;执行ffmpegcmd信息：{}&quot;</span><span class="token punctuation">,</span> lineStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;openFFmpegExe执行异常：{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ffmpegCmd <span class="token operator">=</span> <span class="token string">&quot;D:\\\\software\\\\ffmpeg\\\\bin\\\\ffmpeg.exe  -re -i D:\\\\2.mp4 -c copy -f flv rtmp://192.168.133.128:20935/liveTest/room1&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//        String ffmpegCmd = &quot;ffmpeg.exe -re -i rtsp://127.0.0.1:8554/video -rtsp_transport tcp -buffer_size 102400 -vcodec copy -an -f flv rtmp://192.168.133.128:1935/live/room1&quot;;</span>
        <span class="token class-name">JavaFFMpegUtil</span><span class="token punctuation">.</span><span class="token function">execCmd</span><span class="token punctuation">(</span>ffmpegCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="几种浏览器播放rtsp视频流解决方案"><a href="#几种浏览器播放rtsp视频流解决方案" class="header-anchor">#</a> 几种浏览器播放RTSP视频流解决方案</h2> <p>【WebSocket透传】RTSP视频流转换为flv，通过websocket传输flv视频流，然后前端通过websocket获取到视频流后，使用flvjs对视频流再一次处理并进行播放（项目中已使用）
【协议转换】RTSP转RTMP到RTMP服务器，转http-flv，播放端用flv.js播放（可以使用）
【协议转换】RTSP转RTMP到RTMP服务器，转hls，播放端用video.js播放（m3u8延迟高）
【安装插件】VLC或者SmartPlayer第三方插件播放（插件局限）
【实时通讯技术】RTSP转WebRTC播放（未来趋势）
【代理服务器】H5 + websocket_rtsp_proxy 实现视频流直播【收费的，免费版有很多限制】</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.becc5145.js" defer></script><script src="/assets/js/2.8a031f56.js" defer></script><script src="/assets/js/20.7ea2bb80.js" defer></script>
  </body>
</html>
